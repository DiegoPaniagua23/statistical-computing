name: Compile LaTeX Documents

# Trigger the workflow on push to main branch or pull requests
on:
  push:
    branches: [ main ]
    paths: 
      - 'homework/*/report/**'
      - '.github/workflows/latex-compile.yml'
  pull_request:
    branches: [ main ]
    paths: 
      - 'homework/*/report/**'

jobs:
  compile-latex:
    runs-on: ubuntu-latest
    
    steps:
    # Checkout the repository
    - name: Checkout repository
      uses: actions/checkout@v4
      
    # Install LaTeX
    - name: Install LaTeX
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended texlive-lang-spanish texlive-bibtex-extra biber
        
    # Find and compile all main.tex files
    - name: Compile LaTeX documents
      run: |
        # Function to compile a LaTeX document
        compile_tex() {
          local tex_file="$1"
          local dir=$(dirname "$tex_file")
          local base=$(basename "$tex_file" .tex)
          
          echo "ðŸ“ Compiling $tex_file"
          cd "$dir"
          
          # First pass
          pdflatex -interaction=nonstopmode "$base.tex"
          
          # Run bibtex if bibliography exists
          if [ -f "ref.bib" ]; then
            bibtex "$base"
            pdflatex -interaction=nonstopmode "$base.tex"
          fi
          
          # Final pass
          pdflatex -interaction=nonstopmode "$base.tex"
          
          # Check if PDF was created
          if [ -f "$base.pdf" ]; then
            echo "âœ… Successfully created $base.pdf"
            ls -la "$base.pdf"
          else
            echo "âŒ Failed to create $base.pdf"
            exit 1
          fi
          
          cd - > /dev/null
        }
        
        # Find all main.tex files and compile them
        find . -name "main.tex" -type f | while read tex_file; do
          compile_tex "$tex_file"
        done
        
    # Upload PDF artifacts
    - name: Upload PDF artifacts
      uses: actions/upload-artifact@v4
      with:
        name: compiled-pdfs
        path: |
          homework/*/report/*.pdf
        retention-days: 30
        
    # Create a summary
    - name: Create summary
      run: |
        echo "## ðŸ“„ Compiled Documents" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        find . -name "*.pdf" -path "./homework/*" | while read pdf; do
          size=$(stat -f%z "$pdf" 2>/dev/null || stat -c%s "$pdf")
          echo "- $(basename "$pdf") (${size} bytes)" >> $GITHUB_STEP_SUMMARY
        done

  # Optional: Check for LaTeX warnings and errors
  latex-quality-check:
    runs-on: ubuntu-latest
    needs: compile-latex
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Install LaTeX tools
      run: |
        sudo apt-get update
        sudo apt-get install -y texlive-latex-extra chktex
        
    - name: Check LaTeX quality
      run: |
        echo "## ðŸ“‹ LaTeX Quality Report" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        # Find all .tex files and check them
        find . -name "*.tex" -path "./homework/*" | while read tex_file; do
          echo "Checking $tex_file..."
          echo "### $(basename "$tex_file")" >> $GITHUB_STEP_SUMMARY
          
          # Run chktex (LaTeX style checker)
          if chktex -q -n 1 -n 2 -n 3 -n 8 -n 13 -n 36 "$tex_file" > /tmp/chktex_output.txt 2>&1; then
            echo "âœ… No major issues found" >> $GITHUB_STEP_SUMMARY
          else
            echo "âš ï¸ Issues found:" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            head -20 /tmp/chktex_output.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
        done
